<html>
<head>
  <title>Licode Admin</title>
  <style>
    
    .x.axis line {
      shape-rendering: auto;
    }
    
    .line {
      fill: none;
      stroke: #000;
      stroke-width: 1.5px;
    }
    table {
      margin-top:10px;
      margin-bottom:10px;
    }
    td {
      padding:0px;
      padding-top:10px;
      margin-top:10px;
      width:0px;
      width: 60px;
      text-align:center;
    }
    td.header {
      width: 90px;
      text-align:left;
    }   
    
  </style>

  <script src="//code.jquery.com/jquery-1.12.0.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>  <script src="/socket.io/socket.io.js"></script>
  <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="/admin.js" type="text/javascript"></script>
</head>
<body>
  <div id="graphHolder">
  </div>


  <script>
    var DATA_INTERVAL = 1000;
    var socket = io.connect(window.location);
    var licode_data = [];
    var n = 300;
    var latest = {cpu:0, mem:0};
    var id = function() { return Math.ceil(Math.random()*10000000); };

    $(function() {

      socket.on('result', function (resp) {
        if (resp.req.type == "ErizoAgent" && resp.req.method == "getErizoAgents") {
          latest.cpu = Math.ceil(resp.stats.perc_cpu*100)/100;
          latest.mem = Math.ceil(resp.stats.perc_mem*100)/100;
        } else {
          console.log(resp);
        }
      });

      var getLicodeData = function() {
        socket.emit('call', {type:"ErizoAgent", method: "getErizoAgents", id: id()});
        socket.emit('call', {type:'ErizoAgent', method: 'getErizoJSInfo', id: id()});
        // setTimeout(getLicodeData, DATA_INTERVAL);
      };
      getLicodeData();
      

      chart("cpu", [0, 100], [1, n - 2], "basis", function() { return latest.cpu; });
      chart("mem", [0, 100], [1, n - 2], "basis", function() { return latest.mem; });

    });

    /******* FROM OTHER PROJECT *******/
    function chart(title, ydomain, xdomain, interpolation, dataFn) {
      var data = d3.range(n).map(function() { return 0; });

      var margin = {top: 5, right: 0, bottom: 5, left: 100},
        width = 450 - margin.right,
        height = 90 - margin.top - margin.bottom;

      var x = d3.scale.linear()
        .domain(xdomain)
        .range([0, width]);

      var y = d3.scale.linear()
        .domain(ydomain)
        .range([height, 0]);

      var line = d3.svg.line()
        .interpolate(interpolation)
        .x(function(d, i) { return x(i); })
        .y(function(d, i) { return y(d); });

      var tr = d3.select("#graphHolder")
        .append("table")
        .attr("cellpadding", "0")
        .attr("cellspacing", "0")
        .append('tr');
      var header = tr.append('td').attr('class', 'header').html(title);
      
      var svg = tr.append('td').attr('class', 'graph').append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .style("margin-left", -margin.left + "px")
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
      svg.append("defs").append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", width)
        .attr("height", height);

      svg.append("g")
        .attr("class", "y axis")
            .call(d3.svg.axis().scale(y).ticks(5).orient("left"));

      var footer = tr.append('td').html("0")
      var maxVal = tr.append('td').html(0);
      var minVal = tr.append('td').html(100);
      
      var path = svg.append("g")
        .attr("clip-path", "url(#clip)")
        .append("path")
        .data([data])
        .attr("class", "line")
        .attr("d", line);

      var tick = function(path, line, data, x) {
      
        // push a new data point onto the back
        newPoint = dataFn();
        data.push(newPoint);
        
        footer.html(newPoint);
        if (newPoint > parseFloat(maxVal.html())) {
          maxVal.html(newPoint);
        }
        if (newPoint < parseFloat(minVal.html())) {
          minVal.html(newPoint);
        }
        
        // redraw the line, and then slide it to the left
        path.attr("d", line)
          .attr("transform", null)
          .transition()
          .duration(100)
          .ease("linear")
          .attr("transform", "translate(" + x(0) + ")")
          .each("end", function() { tick(path, line, data, x);});
        
        // pop the old data point off the front
        data.shift();
      };
      tick(path, line, data, x);      
    };

  </script>
</body>
</html>
